@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script src="~/Scripts/jquery.unobtrusive-ajax.min.js"></script>
<script src="~/Scripts/jquery.validate.min.js"></script>

<div class="row mx-0 mt-5 justify-content-center">
    <div class="col-8 py-4 jumbotron visibility3">
        <h2 class="text-center">Request a credit</h2>
        <hr />


        <div class="row mx-0">
            <div class="col pl-0">
                <h3 class="text-center">Simple procedures</h3>
                Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
                Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
                Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum
            </div>

            <div class="col">
                <h3 class="text-center">Complete the form</h3>
                <form id="obtainCreditForm">

                    <div class="input-group mt-3">
                        <input type="text" id="formCreditAmount" placeholder="Credit amount" name="formCreditAmount" class="form-control" />
                        <div class="input-group-append">
                            <span class="input-group-text">PLN</span>
                        </div>
                    </div>

                    <div class="input-group mt-3">
                        <label>Credit period</label>
                        <input type="range" class="custom-range" id="formPeriodInput" min="1" max="10" />
                        <label id="formPeriodValue"></label>
                    </div>


                    <button type="submit" id="formSubmitButton" class="btn btn-primary btn-block mt-3">Obtain</button>
                </form>

            </div>
        </div>
        <hr />
        <div class="row justify-content-center">
            <div class="col">
                <p class="text-center">
                    Not sure about credit conditions? Use our calculator and customize them to your needs!<br />
                    <button type="button" class="btn btn-primary mt-3" data-toggle="modal" data-target="#calculatorModal">Open calculator</button>
                </p>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="calculatorModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content px-4 py-2">
            <div class="modal-header px-0">
                <h5 class="modal-title">Credit calculator</h5>
                <button type="button" class="close text-danger" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body px-0">

                <form id="calculateCredit">
                    <div class="input-group mb-3">
                        <input class="form-control" type="text" id="calculatorCreditAmount" placeholder="Credit amount" name="calculatorCreditAmount"/>
                        <div class="input-group-append">
                            <span class="input-group-text">PLN</span>
                        </div>
                    </div>

                    <div class="input-group mb-3">
                        <input class="form-control" type="text" id="calculatorPercentageRate" placeholder="Percentage rate" name="calculatorPercentageRate"/>
                        <div class="input-group-append">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>

                    <div class="input-group mb-3">
                        <label for="creditPeriod">Credit period</label>
                        <input type="range" class="custom-range" value="5" min="1" max="10" step="1" id="calculatorPeriodInput" />
                        <label id="calculatorPeriodValue"></label>
                    </div>

                    <button type="submit" id="calculateButton" class="btn btn-primary btn-block">Calculate</button>

                </form>

            </div>
            <div class="modal-footer px-0">
                <div class="alert alert-primary w-100" role="alert" id="creditInfoSuccess"></div>
                <div class="alert alert-danger w-100" role="alert" id="creditInfoError"></div>
            </div>
        </div>
    </div>
</div>

@section scripts
{

    <script>
        $(document).ready(function () {

            $.validator.addMethod("regex", function (value, element, regexpr) {
                return this.optional(element) || value.match(typeof regexpr == "string" ? new RegExp(regexpr) : regexpr);
            }, "Please provide a valid input");

            $("#obtainCreditForm").validate({
                rules: {
                    formCreditAmount: {
                        required: true,
                        regex: /^\d*[.,]?\d{0,2}$/
                    }
                },
                messages: {
                    formCreditAmount: {
                        required: "This field is required",
                        regex: "This field must be a real positive number"
                    }
                },
                submitHandler: function () {
                    var creditDto = {
                        creditAmount: $("#formCreditAmount").val(),
                        installmentCount: $("#formPeriodInput").val() * 12
                    };

                    $.ajax({
                        method: "POST",
                        url: "/api/credits/obtaincredit",
                        data: creditDto,
                        success: function (data) {
                            swal({
                                title: "Success",
                                text: data,
                                icon: "success",
                                button: "OK"
                            });
                        },
                        error: function (data) {
                            swal({
                                title: "Error",
                                text: data.responseJSON.message,
                                icon: "error",
                                button: "OK"
                            });
                        }
                    });
                },
                errorPlacement: function (error, element) {
                    error.appendTo(element.parent());
                }
            });

            $("#calculateCredit").validate({
                rules: {
                    calculatorCreditAmount: {
                        required: true,
                        regex: /^\d*[.,]?\d{0,2}$/
                    },
                    calculatorPercentageRate: {
                        required: true,
                        regex: /^\d*[.,]?\d{0,2}$/
                    }
                },
                messages: {
                    calculatorCreditAmount: {
                        required: "This field is required",
                        regex: "This field must be a real positive number"
                    }, 
                    calculatorPercentageRate: {
                        required: "This field is required",
                        regex: "This field must be a real positive number"
                    }
                },
                submitHandler: function () {
                    var amount = $("#calculatorCreditAmount").val();
                    var rate = $("#calculatorPercentageRate").val();
                    var installments = $("#calculatorPeriodInput").val() * 12;

                    var creditDto = {
                        creditAmount: amount,
                        percentageRate: rate,
                        installmentCount: installments
                    };

                    $.ajax({
                        method: "GET",
                        url: "/api/credits/calculate",
                        data: creditDto,
                        success: function (d) {
                            console.log(d);
                            $("#creditInfoError").hide();
                            $("#creditInfoSuccess").html("<strong>" + installments + "</strong>" + " installments, " + "<strong>" + (parseFloat(d)).toFixed(2) + "</strong>" + " each. Total amount: " + "<strong>" + (d * installments).toFixed(2) + "</strong>");
                            $("#creditInfoSuccess").slideDown();
                        },
                        error: function (d) {
                            $("#creditInfoSuccess").hide();
                            $("#creditInfoError").html("<strong>" + d.responseJSON.message + "</strong>");
                            $("#creditInfoError").slideDown();
                        }
                    });
                },
                errorPlacement: function (error, element) {
                    error.appendTo(element.parent());
                }
            });

            var getYearSpelling = function (value) {
                if (value == 1)
                    return " year";
                else
                    return " years";
            };

            var adjustNumberOfYears = function (elementToAdjust) {
                var currentPeriod = $(elementToAdjust + "Input").val();
                $(elementToAdjust + "Value").html(currentPeriod + getYearSpelling(currentPeriod));
            };

            (function () {
                adjustNumberOfYears("#formPeriod");
                adjustNumberOfYears("#calculatorPeriod");

                $("#formPeriodInput").on("input", function () {
                    var name = $(this).attr("id").replace("Input", "");
                    adjustNumberOfYears("#" + name);
                });

                $("#calculatorPeriodInput").on("input", function () {
                    var name = $(this).attr("id").replace("Input", "");
                    adjustNumberOfYears("#" + name);
                });

                $("#creditInfoSuccess").hide();
                $("#creditInfoError").hide();

            })();

            $("#calculatorModal").on("hidden.bs.modal", function () {
                $("#creditInfoSuccess").hide();
                $("#creditInfoError").hide();
            });

        });
    </script>

}